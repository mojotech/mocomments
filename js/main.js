(function(){}).call(this),function(){var a,b,c,d,e,f=function(a,b){return function(){return a.apply(b,arguments)}};require.config({paths:{jquery:"//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min"}}),require(["jquery"],function(a){return new Comojo({commentable:"p.commentable",container:".contain"})}),window.Comojo=function(){function a(a){this._setupCommentEntry=f(this._setupCommentEntry,this),this._bindClicks=f(this._bindClicks,this),this._addIndicators=f(this._addIndicators,this);var b=this;this.options=$.extend({el:"p",url:window.location.href,ouathio:{key:"6bTbWgdrEePCI7uTh9We_BPmULs"},parse:{id:"ZPbImnCfvuyidc6cJjI6dVSq5nOJJp5OWMiUQh6w",key:"8VImXPt6ggcOTkW11QYuxaogLb8QLEl9HzS4zwt3"}},a),this.$container=$(this.options.container),this.$commentable=this.$container.find(this.options.commentable),this.$commentable.addClass("mc-indicated"),d.fetch().then(function(){return Parse.initialize(b.options.parse.id,b.options.parse.key),b._=Parse._,b._createPage(Parse.Object.extend("Page"),b._bindClicks)})}return a.prototype._createPage=function(a,c){var d,e=this;return d=new Parse.Query(a),d.equalTo("url",this.options.url),d.find().then(function(d){var f;return f=d[0]||new a,d.length?(e.comments=new(b(f)),e.comments.fetch().then(e._addIndicators)):f.save({url:e.options.url}).then(function(){return e.comments=new(b(f))}),c(f)})},a.prototype._addIndicators=function(a){var b;return b=this._countsByEl(a),this.$commentable.each(function(a,c){return $(c).append(templates.indicator({count:b[a]||"+"}))})},a.prototype._countsByEl=function(a){var b;return b=a.groupBy(function(a){return a.get("elIndex")}),this._.object(this._.keys(b),this._.map(b,function(a,b){return a.length}))},a.prototype._bindClicks=function(a){var b=this;return this.$commentable.on("click",".mc-indicator",function(c){var d;return d=$(c.target).parent(),b._ensureAuth(function(c){return b._setupCommentEntry(c,d,a)})})},a.prototype._setupCommentEntry=function(a,b,d){var e,f,g=this;return this.commentsView&&this.commentsView.remove(),this.commentsView=new(c(d,b,this.$container,this.$commentable))({model:$.extend(a,{target:b,comments:{raw:this.comments,filtered:this.comments.filter(function(a){return a.get("elIndex")===g.$commentable.index(b)})}})}),$("body").append(this.commentsView.render().el),$(".mc-input-comment").focus(),f=(e=this.$container.css("right")==="auto")?0:parseInt(e,10),this.$container.css({position:"relative",left:"auto",right:f}),this.$container.css({"-webkit-transition":"right 150ms",right:Math.max(250-($("body").width()-this.$container[0].getBoundingClientRect().right),f),width:this.$container.width()})},a.prototype._ensureAuth=function(a){var b=this;return this.user?a(this.user):(e.initialize(this.options.ouathio.key),e.getUser(function(c){return b.user=c,a(c)}))},a}(),c=function(a,b,c,d){return Parse.View.extend({className:"mc-comment-entry",template:templates.comment_entry,events:{"input .mc-input-comment":"autoGrow","keydown .mc-input-comment":"onKeyPress","click .mc-save-link":"save","click .mc-close-link":"close"},render:function(){var a=this;return this.$el.html(this.template(this.model)),this.$el.css({position:"absolute",width:250,top:b.offset().top,right:0,"z-index":9999}),Parse._.defer(function(){return $("body").on("click.mc-close-comment-entry",function(b){return a.close(b)})}),this},autoGrow:function(a){var b;return b=$(a.target),b.height(""),b.height(b.prop("scrollHeight"))},onKeyPress:function(a){if(a.keyCode===13)return a.preventDefault(),this.save()},close:function(a){return a&&a.preventDefault(),$(a.target).hasClass("mc-indicator")||$(a.target).hasClass("mc-comment-entry")||$(".mc-comment-entry").has(a.target).length&&!$(a.target).hasClass("close-link")?!1:($("body").off("click.mc-close-comment-entry"),c.attr("style"," "),this.remove())},save:function(c){var e;c&&(c.stopImmediatePropagation(),c.preventDefault());if(!(e=this.$(".mc-input-comment").val()))return;return this.model.comments.raw.create({page:a,elIndex:d.index(b),body:e,commenter:{name:this.model.screen_name,avatar:this.model.profile_image_url}}),this.$(".mc-comments").append(this.model.comments.raw.last().display()),$(b).find(".mc-indicator").text(this.$(".mc-comments .mc-comment").length),this.$(".mc-entry").remove()}})},d={resources:["//cdn.jsdelivr.net/parse/1.2.9/parse.js","https://oauth.io//auth/download/latest/oauth.min.js"],fetch:function(){return $.when.apply($,this.resources.map($.getScript))}},e={initialize:function(a){return OAuth.initialize(a)},getUser:function(a){var b;return(b=localStorage.getItem("comojoUser"))?a(JSON.parse(b)):OAuth.popup("twitter",function(b,c){return c.get("/1.1/account/settings.json").done(function(b){return c.get({url:"/1.1/users/show.json",data:{screen_name:b.screen_name},success:function(b){return localStorage.setItem("comojoUser",JSON.stringify(b)),a(b)}})})})}},b=function(b){var c;return c=a(),Parse.Collection.extend({model:c,query:(new Parse.Query(c)).equalTo("page",b)})},a=function(){return Parse.Object.extend("Comment",{display:function(){return templates.comment({c:this.get("commenter"),body:this.get("body")})}})}}.call(this)